<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>COVID-19</title>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-EBZR5PXS5X"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-EBZR5PXS5X');
  </script>
  <!-- end of GA -->

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.4.1.min.js" crossorigin="anonymous"></script>

  <!-- Simple i18n: https://i18njs.com/ -->
  <script src="https://i18njs.com/js/i18n.min.js"></script>

  <!-- fake function to bypass the node.js require() code. Must be defined before the local .js files are imported. -->
  <script> function require() { } </script>

  <!-- for lib_sthash.js -->
  <script src="https://cdn.jsdelivr.net/gh/emn178/js-sha256@master/build/sha256.min.js"></script>
  <!-- for parsers.js -->
  <script src="https://cdn.jsdelivr.net/gh/NaturalIntelligence/fast-xml-parser@master/lib/parser.min.js"></script>

  <!-- local .js files -->
  <script src="algos.js"></script>
  <script src="i18n.js"></script>
  <script src="lib_sthash.js"></script>
  <script src="parsers.js"></script>
  <script src="test.js"></script>
  <script src="utils.js"></script>

  <!-- Materialize: Compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

  <link rel="stylesheet" type="text/css" href="style.css">

  <script>
    // Global variables
    var PARAMS;  // URL parameters. Type: URLSearchParams
    var PATIENTS = Array();  // TODO: deprecate PATIENTS
    var HASHES = Array();
    var TOTAL_FOUND;  // Number of found overlapped points.

    function parseUrlParams() {
      PARAMS = new URLSearchParams(window.location.search);
    }

    // Return true if the code is running at production.
    function is_production() {
      return window.location.hostname.match("github.io") != null;
    }

    function log(message) {
      if (is_production()) {
        return;
      }

      const logs = $("#logs");
      logs.html(logs.html() + message + '\n');
      // scroll to the bottom.
      logs.scrollTop(1e10);
    }

    // Select the tab.
    //
    // Args:
    //   tab_id: str. e.g. "step2"
    //
    function selectTab(tab_id) {
      $('.tabs').tabs('select', tab_id);
    }

    // Returns Array of points.
    function parseFile(filename, file_text) {
      if (filename.endsWith(".kml")) {
        return parseKml(file_text);
      } else if (filename.endsWith(".json")) {
        return parseJson(file_text);
      } else {
        alert("parseFile(): unsupported filename: " + filename);
      }
    }

    function fetchHttpFile(path) {
      var req = new XMLHttpRequest();
      req.open("GET", path, false);
      req.setRequestHeader("Content-Type", "text/*");
      req.send(null);

      return req.response;
    }

    function loadPatientData() {
      log(i18n("LOADING_TRACKING"));

      let load_files_elem = $("#loadFiles");
      let load_files = [];
      if (PARAMS.get("hashes")) {
        // The hashed file format:
        //
        //   {
        //     'desc': DESCRIPTION,
        //     'hashes': [ ... ],
        //   }
        //
        // TODO: move to parser.js and integrate with parseFile().
        let hashes_path = PARAMS.get("hashes");
        let json_obj = JSON.parse(fetchHttpFile(hashes_path));
        let desc = json_obj.desc;
        let hashes = json_obj.hashes;
        for (hash of hashes) {
          if (hash in HASHES) {
            HASHES[hash].push(desc);
          } else {
            HASHES[hash] = [desc];
          }
        }
        load_files.push({
          desc: desc,
        });
      } else {
        if (PARAMS.get("patient")) {
          load_files.push({
            desc: PARAMS.get("patient"),
            path: PARAMS.get("patient"),
            src: PARAMS.get("patient"),
          });
        } else {
          // Load default data.

          // Taiwan case 32
          load_files.push({
            desc: 'Taiwan 台灣 [案32]',
            path: "countries/taiwan/case-32.output.json",
            src: 'https://drive.google.com/open?id=1QYAkgHR5yykzsVZnTitfEFkNpNd6Ragn&usp=sharing',
          });
          // coronamap.site
          load_files.push({
            desc: 'Korea data [https://coronamap.site]',
            path: "countries/korea/coronamap.site-output.json",
            src: 'https://coronamap.site',
          });

          /* DO NOT LOAD because it has less data.
          // coronamap.live
          load_files.push({
            desc: 'Korea data (coronamap.live)',
            path: "countries/korea/coronamap.live-output.json",
            src: 'https://coronamap.live',
          });
          */
        }

        for (let file of load_files) {
          let points = parseFile(file.path, fetchHttpFile(file.path));
          file.num_points = points.length;
          log(JSON.stringify(points).split("},{").join("},\n{"));  // one line for each record.
          PATIENTS.push({
            'desc': file.desc,
            'points': points,
          });
        }
      }

      for (let file of load_files) {
        let add_html = "<LI>";
        if (file.src) { add_html += `<a target='_blank' href='${file.src}'>`; }
        add_html += file.desc + " (" + file.num_points + ")";
        if (file.src) { add_html += "</a>"; }
        add_html += "\n";
        load_files_elem.html(load_files_elem.html() + add_html);
      }

      log(i18n("DONE_LOADING"));
    }

    function twoDigits(num) {
      return num < 10 ? "0" + num : num;
    }

    function myLocaleTime(timestamp) {
      var date = new Date(timestamp * 1000);
      return date.getFullYear() + "/" + twoDigits(date.getMonth() + 1) + "/" + twoDigits(date.getDate()) + " " +
        twoDigits(date.getHours()) + ":" + twoDigits(date.getMinutes());
    }

    function showContacts(contacts) {
      // TODO: de-duplicate contacts

      console.log(contacts);
      var html = "";
      for (let contact of contacts) {
        // TODO: show in-page static map to avoid opening a new window.
        html += "<li>" + myLocaleTime(contact.begin) + " ~ " +
          myLocaleTime(contact.end) + ": " +
          " <a target=_blank href='http://maps.google.com/?q=" + contact.lat + "," + contact.lng + "'>" + contact.user_desc + "</a>" +
          " lat:" + contact.lat + " lng:" + contact.lng;
      }
      return html || null;
    }

    function loadFileContentAsync(file_blob) {
      return new Promise((resolve, reject) => {
        let reader = new FileReader();

        reader.onload = (fp) => {
          resolve(fp.target.result);
        };

        reader.onerror = reject;

        reader.readAsText(file_blob, "UTF-8");
      });
    }

    async function processFile(file_blob) {
      console.log(file_blob);
      var filename = file_blob.name;
      const display = $("#results");
      if (filename.endsWith(".kml") || filename.endsWith(".json")) {
        log(i18n("ANALYZING", { filename: filename }));
        appendResults(i18n("ANALYZING", { filename: filename }));
        let file_text = await loadFileContentAsync(file_blob);
        let points = parseFile(filename, file_text);

        var contacts = Array();
        contacts = contacts.concat(checkContact(points, PATIENTS));
        contacts = contacts.concat(checkHashes(points, HASHES));

        appendResults(showContacts(contacts));

        TOTAL_FOUND += contacts.length;

        log(i18n("DONE_ANALYZE", {
          filename: filename,
          contacts_length: contacts.length
        }));
        appendResults(i18n("DONE_ANALYZE", {
          filename: filename,
          contacts_length: contacts.length
        }));
      } else {
        alert(i18n("UNSUPPORTED_FILE_TYPE", { filename: filename }));
      }
    }

    function clearResults() {
      TOTAL_FOUND = 0;
      $("#results").html("");  // reset result
      $("#HTML_EXPLAIN_NOT_FOUND").hide();
      $("#HTML_EXPLAIN_FOUND_RESULTS").hide();
    }

    // Prepend a string in the beginning of the resutls.
    function prependResults(msg) {
      if (msg === null) return;
      const display = $("#results");
      if (!msg.endsWith('\n')) {
        msg += '\n';
      }
      display.html(msg + display.html());
    }

    function appendResults(msg) {
      if (msg === null) return;
      const display = $("#results");
      if (!msg.endsWith('\n')) {
        msg += '\n';
      }
      display.html(display.html() + msg);
    }

    function finishResults() {
      prependResults(i18n("FINISH_RESULTS", { total_found: TOTAL_FOUND }));
      $("#results").scrollTop(0);

      if (TOTAL_FOUND == 0) {
        $("#HTML_EXPLAIN_NOT_FOUND").show();
      } else {
        $("#HTML_EXPLAIN_FOUND_RESULTS").show();
      }
    }

    // The common code for file type and drap&drop handler.
    //
    // Args:
    //   blobs: array of File Blobs.
    function processBlobs(blobs) {
      selectTab("step4");
      clearResults();

      const promises = [];
      for(let blob of blobs) {
        promises.push(processFile(blob));
      }

      Promise.all(promises).then(
        finishResults
      ).catch(
        (e) => console.error(e)
      );
    }

    function onClickLetsCheckButton() {
      let oFiles = document.getElementById("uploadInput").files;

      if (oFiles.length === 0) return;

      const blobs = [];
      for (let oFile of oFiles) {
        blobs.push(oFile);
      }

      processBlobs(blobs);
    }

    // Kodus: https://developer.mozilla.org/en-US/docs/Web/API/HTML_Drag_and_Drop_API/File_drag_and_drop
    //
    function dropHandler(ev) {
      // Prevent default behavior (Prevent file from being opened)
      ev.preventDefault();

      const blobs = [];
      for (let item of ev.dataTransfer.items) {
        if (item.kind === 'file') {
          blobs.push(item.getAsFile());
        }
      }

      processBlobs(blobs);
    }

    function dragOverHandler(ev) {
      // Prevent default behavior (Prevent file from being opened)
      ev.preventDefault();
    }

    function downloadKml(period) {
      var begin, end;
      if (period.startsWith('-')) {
        // last N seconds
        let now = (+ new Date()) / 1000;  // get cuurent timestamp
        begin = now - parseInt(period.substr(1));
        end = now;
      } else {
        // period seperated by comma
        [begin, end] = period.split(",");
        [begin, end] = [parseInt(begin), parseInt(end)];
      }

      const secs_per_day = 24 * 60 * 60;
      for (let timestamp = begin; timestamp <= end; timestamp += secs_per_day) {
        let date = new Date(timestamp * 1000);
        let year = date.getFullYear();
        let month = date.getMonth();  // starts from 0
        let mday = date.getDate();
        let download_url = "https://www.google.com/maps/timeline/kml?authuser=0&pb=!1m8!1m3!1i" + year + "!2i" + month + "!3i" + mday +
          "!2m3!1i" + year + "!2i" + month + "!3i" + mday;
        window.open(download_url, "_blank");
      }
    }

    function download_btn_onclick(ev) {
      console.log(ev);
      ev.preventDefault();
      ev.defaultPrevented = false;
      var opt = document.getElementById('download_period');
      var value = opt.options[opt.selectedIndex].value;
      downloadKml(value);
      return false;
    }

    function language_changed() {
      let lang = $("#select_lang option:selected").val();
      window.location.href = "?hl=" + lang;
      return false;
    }

    function onLoad() {
      parseUrlParams();
      load_i18n(function () {
        update_i18n_UI();
        loadPatientData();

        // Initialize Materialize selects after UI components are updated,
        // since Materialize inserts DOM elements based on the state of the
        // selects.
        M.FormSelect.init(document.querySelectorAll('select'), {});
        $('.tabs').tabs();
      });

      document.getElementById('download_btn').onclick = download_btn_onclick;

      // Do not show log field in prod.
      if (is_production()) {
        document.getElementById('logs_title').style.display = 'none';
      }
    }
  </script>
</head>

<body onload="onLoad();">
  <header>
    <div class="container">
      <nav>
        <div class="nav-wrapper">
          <div class="row">
            <div class="col s12">
              <a href="#" id="HTML_APP_NAME" class="brand-logo">COVID-19</a>
              <ul id="nav-mobile" class="right hide-on-med-and-down">
                <li>
                  <form onsubmit="return false;">
                    <select id="select_lang" onchange="language_changed();">
                      <option id="HTML_SELECT_LANGUAGE" disabled selected>Select Language</option>
                      <option value="en-US">English</option>
                      <option value="zh-TW">繁體中文</option>
                      <option value="ko">한국어</option>
                    </select>
                  </form>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <main>
    <div class="container">
      <form name="uploadForm" onsubmit="return false;">
        <p id="HTML_APP_DESCRIPTION">By comparing with your mobile phone historical location data, this program can tell
          you
          whether you have contacted the confirmed patient or not.</p>
        <p id="HTML_PROCESS_IN_LOCAL">For your privacy, your data are ONLY processed in local and will NOT be uploaded to any server.</p>
        <p id="HTML_LOADED_DATA">Loaded Data List</p>
        <pre id="loadFiles"></pre>
        <p id="HTML_WARNING">WARNING! All the matched results are just FYI. If any result is incorrect, please refer to
          the information announced by the authority.</p>
        <hr>

        <div class="row">
          <div class="col s12">
            <ul class="tabs red lighten-5">
              <li class="tab col s3"><a id="HTML_STEP_1" href="#step1" class="active">Step 1</a></li>
              <li class="tab col s3"><a id="HTML_STEP_2" href="#step2">Step 2</a></li>
              <li class="tab col s3"><a id="HTML_STEP_3" href="#step3">Step 3</a></li>
              <li class="tab col s3"><a id="HTML_STEP_4" href="#step4">Step 4</a></li>
            </ul>
          </div>

          <div id="step1" class="col s12">
            <h5 id="HTML_STEP_1_0">Step 1: Confirm your Location History had been opted-in</h5>
            <p id="HTML_STEP_1_1">
              Go to <a href="https://google.com/maps/timeline" target="_blank">Google Maps Timeline</a>.
              If you see red dots on the map (as below screenshot), you have enabled the History Location feature.
              Please move to <a href="#" onclick="selectTab('step2')">step 2</a>.
            </p>
            <img id="IMG_LOCATION_HISTORY_ENABLED" src="locales/en-US/LocationHistoryEnabled.jpg"/>

            <p id="HTML_ENABLE_HISTORY_LOCATION">If you don't see any red dot on the map, you probably need to enable the feature. Click the 'Gear Icon' on the bottom-right of screen. Then opt-in 'Enable Location History'. This will lead you into a concensus page. Enable this feature.</p>
            <img id="IMG_ENABLE_HISTORY_LOCATION" src="locales/en-US/EnableLocationHistory.png"/>
            <p id="HTML_COME_BACK_AND_CHECK">Since you just started collecting your location data, there is no data to match. Please come back another day to match again.</p>
            <hr>
          </div>

          <div id="step2" class="col s12">
            <h5 id="HTML_STEP_2_0">Step 2: Select period to download: </h5>
            <p>
              <span class="input-field inline">
                <select id="download_period">
                  <option id="HTML_LAST_31_DAYS" value="-2678400">last 31 days</option>
                  <option id="HTML_LAST_14_DAYS" value="-1209600" selected>last 14 days</option>
                  <option id="HTML_LAST_7_DAYS" value="-604800">last 3 days</option>
                  <option id="HTML_LAST_3_DAYS" value="-259200">last 3 days</option>
                  <option id="HTML_ONLY_TODAY" value="-0">Today</option>
                </select>
              </span>
              <button id="download_btn"><span id="HTML_DONWLOAD">Download</span></button>
              <span id="HTML_PUNC_PERIOD">.</span>
            </p>
            <p id="HTML_ALLOW_POPUP">* Remember to allow 'pop-ups' in browser, then click the 'Download' button again.</p>
            <hr>
          </div>

          <div id="step3" class="col s12">
            <h5 id="HTML_STEP_3_0">
              Step 3: Open your location history file(s)
            </h5>
            <p>
              <span id="HTML_STEP_3_2">Click here to select KML/JSON file(s)</span>
              <input id="uploadInput" type="file" multiple />
              <button id="HTML_BUTTON_CHECK" onclick="onClickLetsCheckButton()">Let's Check</button>
            </p>
            <div id="drop_zone" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">
              <label id="HTML_DRAG_DROP_AREA" for="uploadInput"
                style="background: #e0e0e0; padding: 100px; display: inline-block;">
                Or drag-drop KML/JSON file(s) to here.
              </label>
            </div>
            <hr>
          </div>

          <div id="step4" class="col s12">
            <h5 id="HTML_STEP_4_0">
              Step 4: See results below.
            </h5>
            <pre id="results"></pre>
            <h5 id="HTML_EXPLAIN_FOUND_RESULTS" style="display: none;">Above result shows that you probably had been in the hot zone with patient(s) within around 100 meters at the particular time period(s). Please check the official announcement from authority to verify the detailed route.</h5>
            <h5 id="HTML_EXPLAIN_NOT_FOUND" style="display: none;">The result shows that you probably haven't been in the hot zone with patient. But we still recommend you to pay attention to authority's announcement and come back to check everyday.</h5>
            <hr>

            <div id='logs_title'>
              <p>Logs</p>
              <pre id="logs" style='overflow: scroll; border: 1px solid; height: 24em; resize: vertical;'></pre>
            </div>
          </div>
        </div>
      </form>
    </div>
  </main>

  <footer>
    <div class="container">
      <div class="row">
        <a id="HTML_SOURCE_CODE" href="https://github.com/yjlou/2019-nCov" target="_blank">Source Code</a> |
        <a id="HTML_CONTACT_US" href="mailto:covid-19@googlegroups.com" target="_blank">Contact us (
          covid-19@googlegroups.com
          )</a>
      </div>
    </div>
  </footer>

  <!-- Materialize: Compiled and minified JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</body>

</html>
