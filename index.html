<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>2019-nCov</title>
<script src="https://raw.githubusercontent.com/Stuk/jszip/master/dist/jszip.min.js">
/*
function decompressZip(file_blob) {
  var zip = new JSZip();
  zip.loadAsync(file_blob) {
     .then(function(zip) {
         // process ZIP file content here
         alert("OK")
     }, function() {alert("Not a valid zip file")});
  };
}
*/
</script>

<script>
function parseKml(text) {
  var parser = new DOMParser();
  var kml = parser.parseFromString(text,"text/xml");
  var output = Array();

  console.log(kml);
  var placemarks = kml.getElementsByTagName("Placemark");
  console.log(placemarks);
  for(var i = 0; i < placemarks.length; i++) {
    var placemark = placemarks[i];
    var latlng = "";
    var time_begin = "";
    var time_end = "";

    var point = placemark.getElementsByTagName("Point");
    console.log(point);
    if (point.length == 0) {
      // Not point data. Maybe LineString data. Discard.
      continue;
    } else if (point.length == 1) {
      latlng = point[0].children[0].innerHTML;
    } else {
      console.error("Invalid point data: ", placemark);
      continue;
    }

    var timespan = placemark.getElementsByTagName("TimeSpan");
    console.log(timespan);
    if (timespan.length == 1) {
      time_begin = timespan[0].children[0].innerHTML;
      time_end = timespan[0].children[1].innerHTML;
    } else {
      console.error("Invalid timespane data: ", placemark);
      continue;
    }

    // Point data: (-122.02223289999999,37.338164,0) 2020-02-07T16:14:56.673Z~2020-02-07T16:20:34.000Z
    console.log("Point data: (" + latlng + ") " + time_begin + "~" + time_end);
    output.push({
      'lat': latlng.split(",")[0],
      'lng': latlng.split(",")[1],
      'begin': time_begin,
      'end': time_end,
    });
  }

  return output;
}

function loadFileContent(file_blob) {
  console.log(file_blob);
  var filename = file_blob.name;
  if (filename.endsWith(".kml")) {
    var oReader = new FileReader();
    oReader.onload = function(e){
      console.log(e);
      var points = parseKml(e.target.result);
      document.getElementById("file_content").innerHTML = JSON.stringify(points);
    };
    oReader.readAsBinaryString(file_blob);
  } else {
    alert("Not supported file type: " + filename);
  }
}

function updateSize() {
  let nBytes = 0,
      oFiles = document.getElementById("uploadInput").files,
      nFiles = oFiles.length;
  for (let nFileId = 0; nFileId < nFiles; nFileId++) {
    nBytes += oFiles[nFileId].size;
    loadFileContent(oFiles[nFileId]);
  }
  let sOutput = nBytes + " bytes";
  // optional code for multiples approximation
  for (let aMultiples = ["KiB", "MiB", "GiB", "TiB", "PiB", "EiB", "ZiB", "YiB"], nMultiple = 0, nApprox = nBytes / 1024; nApprox > 1; nApprox /= 1024, nMultiple++) {
    sOutput = nApprox.toFixed(3) + " " + aMultiples[nMultiple] + " (" + nBytes + " bytes)";
  }
  // end of optional code
  document.getElementById("fileNum").innerHTML = nFiles;
  document.getElementById("fileSize").innerHTML = sOutput;
}

</script>
</head>

<body onload="updateSize();">
<form name="uploadForm">
Select a local file to test.
<p><input id="uploadInput" type="file" name="myFiles" onchange="updateSize();" multiple> selected files: <span id="fileNum">0</span>; total size: <span id="fileSize">0</span></p>
<hr>
File content:
<pre id=file_content></pre>
</form>
</body>
</html>

