<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>2019-nCov</title>
<script src="https://raw.githubusercontent.com/Stuk/jszip/master/dist/jszip.min.js">
/*
function decompressZip(file_blob) {
  var zip = new JSZip();
  zip.loadAsync(file_blob) {
     .then(function(zip) {
         // process ZIP file content here
         alert("OK")
     }, function() {alert("Not a valid zip file")});
  };
}
*/
</script>
<script src="algos.js"></script>
<script src="parsers.js"></script>
<script src="test.js"></script>
<script src="utils.js"></script>

<script>
function loadServerKml(path) {
  var req = new XMLHttpRequest();
  req.open("GET", path, false);
  req.setRequestHeader("Content-Type", "text/xml");
  req.send(null);
  var kml_text = req.response;
  return parseKml(kml_text);
}

var PATIENTS = Array();
function loadPatientData() {
  var points = loadServerKml("kml/Diamond.kml");
  document.getElementById("file_content").innerHTML =
      "讀取病人的軌跡...\n" +
      JSON.stringify(points).split("},{").join("},\n{");//FIXME
  PATIENTS.push({
    'desc': "Diamond Princess",
    'points': points,
  });
}

function loadFileContent(file_blob) {
  console.log(file_blob);
  var filename = file_blob.name;
  if (filename.endsWith(".kml")) {
    var oReader = new FileReader();
    oReader.onload = function(fp){
      var kml_text = fp.target.result;
      var points = parseKml(kml_text);
      // FIXME document.getElementById("file_content").innerHTML = JSON.stringify(points);
      var contacts = checkContact(points, PATIENTS);
      document.getElementById("file_content").innerHTML =
          "比對結果，有重疊的地方：\n" +
          JSON.stringify(contacts).split("},{").join("},\n{");//FIXME
    };
    oReader.readAsText(file_blob, "UTF-8");
  } else {
    alert("Not supported file type: " + filename);
  }
}

function fileTypeProcess() {
  let nBytes = 0,
      oFiles = document.getElementById("uploadInput").files,
      nFiles = oFiles.length;
  for (let nFileId = 0; nFileId < nFiles; nFileId++) {
    nBytes += oFiles[nFileId].size;
    loadFileContent(oFiles[nFileId]);
  }
}

// Kodus: https://developer.mozilla.org/en-US/docs/Web/API/HTML_Drag_and_Drop_API/File_drag_and_drop
//
function dropHandler(ev) {
  // Prevent default behavior (Prevent file from being opened)
  ev.preventDefault();

  // process each file
  for (var i = 0; i < ev.dataTransfer.items.length; i++) {
    if (ev.dataTransfer.items[i].kind === 'file') {
      var file = ev.dataTransfer.items[i].getAsFile();
      loadFileContent(file);
    }
  }
}

function dragOverHandler(ev) {
  // Prevent default behavior (Prevent file from being opened)
  ev.preventDefault();
}

</script>
</head>

<body onload="loadPatientData();">
<form name="uploadForm">
<p>點選這裡選擇 KML 檔上傳<input id="uploadInput" type="file" style="visibility:;" onchange="fileTypeProcess();" multiple/>，</p>
<div id="drop_zone" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">
  <label for="uploadInput" style="background: #e0e0e0; padding: 100px; display: inline-block;">
    或是把 KML 檔案拖到這裡上傳。
  </label>
</div>
<hr>
<pre id=file_content></pre>
</form>
</body>
</html>

