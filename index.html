<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>邂逅</title>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EBZR5PXS5X"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-EBZR5PXS5X');
</script>
<script>
function require() {}  // fake function to bypass the node.js require code.
</script>
<script src="https://cdn.jsdelivr.net/gh/emn178/js-sha256@master/build/sha256.min.js"></script><!-- for lib_sthash.js -->
<script src="https://cdn.jsdelivr.net/gh/NaturalIntelligence/fast-xml-parser@master/lib/parser.min.js"></script><!-- for parsers.js -->
<script src="algos.js"></script>
<script src="lib_sthash.js"></script>
<script src="parsers.js"></script>
<script src="test.js"></script>
<script src="utils.js"></script>

<script>
//
// TODO: i18n
//

// Global variables
var PARAMS;  // URL parameters. Type: URLSearchParams
var PATIENTS = Array();  // TODO: deprecate PATIENTS
var HASHES = Array();
var TOTAL_FOUND;  // Number of found overlapped points.

function parseUrlParams() {
  PARAMS = new URLSearchParams(window.location.search);
}

// Return true if the code is running at production.
function is_production() {
  return window.location.hostname.match("github.io") != null;
}

function log(message) {
  if (is_production()) {
    return;
  }

  const logs = document.getElementById("logs");
  logs.innerHTML += message + '\n';
  // scroll to the bottom.
  logs.scrollTo(0, logs.scrollHeight);
}

// Returns Array of points.
function parseFile(filename, file_text) {
  if (filename.endsWith(".kml")) {
    return parseKml(file_text);
  } else if (filename.endsWith(".json")) {
    return parseJson(file_text);
  } else {
    alert("parseFile(): unsupported filename: " + filename);
  }
}

function fetchHttpFile(path) {
  var req = new XMLHttpRequest();
  req.open("GET", path, false);
  req.setRequestHeader("Content-Type", "text/*");
  req.send(null);

  return req.response;
}

function loadPatientData() {
  log("讀取別人的軌跡中 ...\n");

  let load_files_elem = document.getElementById("loadFiles");
  if (PARAMS.get("hashes")) {
    // The hashed file format:
    //
    //   {
    //     'desc': DESCRIPTION,
    //     'hashes': [ ... ],
    //   }
    //
    // TODO: move to parser.js and integrate with parseFile().
    let hashes_path = PARAMS.get("hashes");
    let json_obj = JSON.parse(fetchHttpFile(hashes_path));
    let desc = json_obj.desc;
    let hashes = json_obj.hashes;
    for(hash of hashes) {
      if (hash in HASHES) {
        HASHES[hash].push(desc);
      } else {
        HASHES[hash] = [desc];
      }
    }
    load_files_elem.innerHTML += "<LI>" + desc + "\n";
  } else {
    if (PARAMS.get("patient")) {
      var path = PARAMS.get("patient");
    } else {
      var path = "kml/test.kml";
    }
    var points = parseFile(path, fetchHttpFile(path));
    log(JSON.stringify(points).split("},{").join("},\n{"));
    PATIENTS.push({
      'desc': "",  // don't know what to put here.
      'points': points,
    });
    load_files_elem.innerHTML += "<LI>" + path + "\n";  // TODO: show meaningful description.
  }
  log("讀取完畢。請開始使用。");
}

function twoDigits(num) {
  return num < 10 ? "0" + num : num;
}

function myLocaleTime(timestamp) {
  var date = new Date(timestamp * 1000);
  return date.getFullYear() + "/" + twoDigits(date.getMonth() + 1) + "/" + twoDigits(date.getDate()) + " " +
         twoDigits(date.getHours()) + ":" + twoDigits(date.getMinutes());
}

function showContacts(contacts) {
  // TODO: de-duplicate contacts

  console.log(contacts);
  var html = "";
  for(let contact of contacts) {
    html += "<li>" + myLocaleTime(contact.begin) + " ~ " +
                     myLocaleTime(contact.end) + ": " +
                     " <a target=_blank href='http://maps.google.com/?q=" + contact.lat + "," + contact.lng + "'>" + contact.user_desc + "</a>" +
                     " lat:" + contact.lat + " lng:" + contact.lng;
  }
  return html;
}

function loadFileContentAsync(file_blob) {
  return new Promise((resolve, reject) => {
    let reader = new FileReader();

    reader.onload = (fp) => {
      resolve(fp.target.result);
    };

    reader.onerror = reject;

    reader.readAsText(file_blob, "UTF-8");
  });
}

async function processFile(file_blob) {
  console.log(file_blob);
  var filename = file_blob.name;
  const display = document.getElementById("results");
  if (filename.endsWith(".kml") || filename.endsWith(".json")) {
    log(`分析 ${filename} ...`);
    let file_text = await loadFileContentAsync(file_blob);
    let points = parseFile(filename, file_text);

    var contacts = Array();
    contacts = contacts.concat(checkContact(points, PATIENTS));
    contacts = contacts.concat(checkHashes(points, HASHES));

    display.innerHTML += showContacts(contacts);
    TOTAL_FOUND += contacts.length;

    log(`完成分析 ${filename} ... 發現 ${contacts.length} 個重疊的地方`);
    finishResults();
  } else {
    alert("Not supported file type: " + filename);
  }
}

function clearResults() {
  TOTAL_FOUND = 0;
  document.getElementById("results").innerHTML = "";  // reset result
}

function finishResults() {
  const display = document.getElementById("results");
  display.innerHTML =
    `比對結果，有 ${TOTAL_FOUND} 個重疊的地方。\n\n` + display.innerHTML;
}

function fileTypeProcess() {
  clearResults();

  let nBytes = 0,
      oFiles = document.getElementById("uploadInput").files,
      nFiles = oFiles.length;

  const promises = [];
  for (let nFileId = 0; nFileId < nFiles; nFileId++) {
    nBytes += oFiles[nFileId].size;
    promises.push(processFile(oFiles[nFileId]));
  }

  Promise.all(promises).then(
    finishResults  // TODO: seems not working. need to investigate.
  ).catch(
    (e) => console.error(e)
  );
}

// Kodus: https://developer.mozilla.org/en-US/docs/Web/API/HTML_Drag_and_Drop_API/File_drag_and_drop
//
function dropHandler(ev) {
  // Prevent default behavior (Prevent file from being opened)
  ev.preventDefault();

  clearResults();

  // process each file
  for (var i = 0; i < ev.dataTransfer.items.length; i++) {
    if (ev.dataTransfer.items[i].kind === 'file') {
      var file = ev.dataTransfer.items[i].getAsFile();
      processFile(file);
    }
  }
}

function dragOverHandler(ev) {
  // Prevent default behavior (Prevent file from being opened)
  ev.preventDefault();
}

function downloadKml(period) {
  var begin, end;
  if (period.startsWith('-')) {
    // last N seconds
    let now = (+ new Date()) / 1000;  // get cuurent timestamp
    begin = now - parseInt(period.substr(1));
    end = now;
  } else {
    // period seperated by comma
    [begin, end] = period.split(",");
    [begin, end] = [parseInt(begin), parseInt(end)];
  }

  const secs_per_day = 24 * 60 * 60;
  for(let timestamp = begin; timestamp <= end; timestamp += secs_per_day) {
    let date = new Date(timestamp * 1000);
    let year = date.getFullYear();
    let month = date.getMonth();  // starts from 0
    let mday = date.getDate();
    let download_url = "https://www.google.com/maps/timeline/kml?authuser=0&pb=!1m8!1m3!1i" + year + "!2i" + month + "!3i" + mday +
                                                                                  "!2m3!1i" + year + "!2i" + month + "!3i" + mday;
    window.open(download_url, "_blank");
  }
}

function download_btn_onclick(ev) {
  console.log(ev);
  ev.preventDefault();
  ev.defaultPrevented = false;
  var opt = document.getElementById('download_period');
  var value = opt.options[opt.selectedIndex].value;
  downloadKml(value);
  return false;
}

function onLoad() {
  parseUrlParams();
  loadPatientData();

  document.getElementById('download_btn').onclick = download_btn_onclick;

  // Do not show log field in prod.
  if (is_production()) {
    document.getElementById('logs_title').style.display = 'none';
  }
}
</script>
</head>

<body onload="onLoad();">
<form name="uploadForm" onsubmit="return false;">
<h1>邂逅</h1>
<p>已載入可供比對的資料：</p>
<pre id="loadFiles"></pre>
<hr>

<p>第一步：先到 <a href="https://google.com/maps/timeline" target="_blank">Google Maps 時間軸</a>，確認你的定位紀錄已經開啟。</p>
<p>然後下載 KML 檔。
  <select id="download_period">
    <option value="1577836800,1580515199">2020年一月份</option>
    <option value="-1209600">最近 14 天</option>
    <option value="-0">今天</option>
  </select>
  <button id="download_btn">下載</button>。
</p>
<p>* 記得點選瀏覽器網址「允許」彈跳視窗後，重新再點選「下載」。</p>
<hr>

<p>第二步：開啟你的軌跡檔</p>
<p>點選這裡選 KML/JSON 檔<input id="uploadInput" type="file" style="visibility:;" onchange="fileTypeProcess();" multiple/>，</p>
<div id="drop_zone" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">
  <label for="uploadInput" style="background: #e0e0e0; padding: 100px; display: inline-block;">
    或是把 KML/JSON 檔案拖到這裡。
  </label>
</div>
<hr>
<p>第三步：查看結果。</p>
<pre id="results"></pre>
<hr>
<div id='logs_title'>
  <p>Logs</p>
  <pre style='overflow: scroll; border: 1px solid; height: 24em' id="logs"></pre>
</div>
</form>
<hr>
<a href="https://github.com/yjlou/2019-nCov" target="_blank">原始程式碼</a>
</body>
</html>

