<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>2019-nCov</title>
<script src="https://raw.githubusercontent.com/Stuk/jszip/master/dist/jszip.min.js">
/*
function decompressZip(file_blob) {
  var zip = new JSZip();
  zip.loadAsync(file_blob) {
     .then(function(zip) {
         // process ZIP file content here
         alert("OK")
     }, function() {alert("Not a valid zip file")});
  };
}
*/
</script>
<script src="algos.js"></script>
<script src="parsers.js"></script>
<script src="test.js"></script>
<script src="utils.js"></script>

<script>
// Global variables
var PARAMS;  // URL parameters. Type: URLSearchParams
var PATIENTS = Array();

function parseUrlParams() {
  PARAMS = new URLSearchParams(window.location.search);
}

// Returns Array of points.
function parseFile(filename, file_text) {
  if (filename.endsWith(".kml")) {
    return parseKml(file_text);
  } else if (filename.endsWith(".json")) {
    return parseJson(file_text);
  } else {
    alert("parseFile(): unsupported filename: " + filename);
  }
}

function fetchHttpFile(path) {
  var req = new XMLHttpRequest();
  req.open("GET", path, false);
  req.setRequestHeader("Content-Type", "text/*");
  req.send(null);
  var kml_text = req.response;

  return parseFile(path, kml_text);
}

function loadPatientData() {
  if (PARAMS.get("patient")) {
    var points = fetchHttpFile(PARAMS.get("patient"));
  } else {
    var points = fetchHttpFile("kml/Diamond.kml");
  }
  document.getElementById("file_content").innerHTML =
      "讀取病人的軌跡...\n" +
      JSON.stringify(points).split("},{").join("},\n{");
  PATIENTS.push({
    'desc': "Diamond Princess",
    'points': points,
  });
}

function loadFileContent(file_blob) {
  console.log(file_blob);
  var filename = file_blob.name;
  if (filename.endsWith(".kml") || filename.endsWith(".json")) {
    var oReader = new FileReader();
    oReader.onload = function(fp){
      var file_text = fp.target.result;
      var points = parseFile(filename, file_text);
      var contacts = checkContact(points, PATIENTS);
      document.getElementById("file_content").innerHTML =
          "比對結果，有 " + contacts.length + " 個重疊的地方：\n\n" +
          JSON.stringify(contacts).split("},{").join("},\n{");
    };
    oReader.readAsText(file_blob, "UTF-8");
  } else {
    alert("Not supported file type: " + filename);
  }
}

function fileTypeProcess() {
  let nBytes = 0,
      oFiles = document.getElementById("uploadInput").files,
      nFiles = oFiles.length;
  for (let nFileId = 0; nFileId < nFiles; nFileId++) {
    nBytes += oFiles[nFileId].size;
    loadFileContent(oFiles[nFileId]);
  }
}

// Kodus: https://developer.mozilla.org/en-US/docs/Web/API/HTML_Drag_and_Drop_API/File_drag_and_drop
//
function dropHandler(ev) {
  // Prevent default behavior (Prevent file from being opened)
  ev.preventDefault();

  // process each file
  for (var i = 0; i < ev.dataTransfer.items.length; i++) {
    if (ev.dataTransfer.items[i].kind === 'file') {
      var file = ev.dataTransfer.items[i].getAsFile();
      loadFileContent(file);
    }
  }
}

function dragOverHandler(ev) {
  // Prevent default behavior (Prevent file from being opened)
  ev.preventDefault();
}

</script>
</head>

<body onload="parseUrlParams(); loadPatientData();">
<form name="uploadForm">
<p>點選這裡選擇 KML 檔上傳<input id="uploadInput" type="file" style="visibility:;" onchange="fileTypeProcess();" multiple/>，</p>
<div id="drop_zone" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">
  <label for="uploadInput" style="background: #e0e0e0; padding: 100px; display: inline-block;">
    或是把 KML 檔案拖到這裡上傳。
  </label>
</div>
<hr>
<pre id=file_content></pre>
</form>
</body>
</html>

